<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Увійти через Telegram</title>
  <link href="../dist/output.css" rel="stylesheet" />
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100">

  <div class="bg-white p-8 rounded-lg shadow text-center">
    <h1 class="text-2xl font-bold mb-4">Вхід у сервіс "Касатка"</h1>
    <p class="mb-6 text-gray-600">Увійдіть через Telegram</p>

    <!-- Telegram Login Widget -->
    <script async src="https://telegram.org/js/telegram-widget.js?7"
      data-telegram-login="kasatka_assistant_bot"
      data-size="large"
      data-userpic="false"
      data-request-access="write"
      data-userpic="false"
      data-on-auth="onTelegramAuth"
    ></script>
  </div>

  <script type="module">
    import { supabase } from './js/supabaseClient.js';

    window.onTelegramAuth = async function(user) {
      const telegramId = user.id.toString();

      // спроба знайти користувача
      const { data, error } = await supabase
        .from('users')
        .select('id')
        .eq('telegram_id', telegramId)
        .single();

      if (error && error.code !== 'PGRST116') {
        alert("Помилка під час перевірки користувача");
        console.error(error);
        return;
      }

      // якщо користувача немає, створити
      if (!data) {
        const { error: insertError } = await supabase
          .from('users')
          .insert([{ telegram_id: telegramId }]);

        if (insertError) {
          alert("Помилка під час створення користувача");
          console.error(insertError);
          return;
        }
      }

      // зберегти telegram_id у localStorage
      localStorage.setItem("kasatka_telegram_id", telegramId);

      // перейти на index.html
      window.location.href = "index.html";
    };
  </script>
</body>
</html>
